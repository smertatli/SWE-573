{% extends 'main.html' %} 

{% load static %} 



{% block content %}

<link rel="stylesheet" href="/static/dist-assets/css/plugins/smart.wizard/smart_wizard.min.css" />
<link rel="stylesheet" href="/static/dist-assets/css/plugins/smart.wizard/smart_wizard_theme_arrows.min.css" />
<link rel="stylesheet" href="/static/dist-assets/css/plugins/smart.wizard/smart_wizard_theme_circles.min.css" />
<link rel="stylesheet" href="/static/dist-assets/css/plugins/smart.wizard/smart_wizard_theme_dots.min.css" />


{% csrf_token %} 


 
            <!--  SmartWizard html -->
            <div id="smartwizard" class="sw-main sw-theme-default" >
                <ul class="nav nav-tabs step-anchor">
                    <li class="nav-item active"><a href="#step-1" class="nav-link">Step 1<br><small>This is step description</small></a></li>
                    <li class="nav-item"><a href="#step-2" class="nav-link">Step 2<br><small>This is step description</small></a></li>
                    <li class="nav-item"><a href="#step-3" class="nav-link">Step 3<br><small>This is step description</small></a></li>
                    <li class="nav-item"><a href="#step-4" class="nav-link">Step 4<br><small>This is step description</small></a></li>
                   
                </ul>
                <div>
                    <div id="step-1">
                        <h3 class="border-bottom border-gray pb-2">Select a data source below</h3>
                            <table id="time_1" class="display" cellspacing="0" width="100%" >
                                <thead>
                                   <tr>
                                      <th></th>
                                      <th>query_name</th>
                                      <th>query</th>
                                      <th>frequency_level1</th>
                                      <th>frequency_level2</th>
                                      <th>fetch_size</th>
                                   </tr>
                                </thead>
                                <tfoot>
                                   <tr>
                                      <th></th>
                                      <th>query_name</th>
                                      <th>query</th>
                                      <th>frequency_level1</th>
                                      <th>frequency_level2</th>
                                      <th>fetch_size</th>
                                   </tr>
                                </tfoot>
                             </table>
                    </div>
                    <div id="step-2" >
                        <h3 class="border-bottom border-gray pb-2">Step 2 Content</h3>
                         <button   onclick='step_first();'>Get collected dates</button>
                         <select name="date_start" id="selectStartDate1"></select>
                         <select name="date_end" id="selectEndDate1"></select>
                    </div>
                    <div id="step-3"  >
                        <h3 class="border-bottom border-gray pb-2">Step 3 Content</h3>
                        
                        <table id="time_2" class="display" cellspacing="0" width="100%" >
                            <thead>
                               <tr>
                                  <th></th>
                                  <th>query_name</th>
                                  <th>query</th>
                                  <th>frequency_level1</th>
                                  <th>frequency_level2</th>
                                  <th>fetch_size</th>
                               </tr>
                            </thead>
                            <tfoot>
                               <tr>
                                  <th></th>
                                  <th>query_name</th>
                                  <th>query</th>
                                  <th>frequency_level1</th>
                                  <th>frequency_level2</th>
                                  <th>fetch_size</th>
                               </tr>
                            </tfoot>
                         </table>
                    </div>
                    <div id="step-4"  >
                        <h3 class="border-bottom border-gray pb-2">Step 2 Content</h3>
                        <button   onclick='step_second();'>Get collected dates</button>
                        <select name="date_start2" id="selectStartDate2"></select>
                        <select name="date_end2" id="selectEndDate2"></select>
                       
                    </div>
                </div>
            </div>
    



<button class="btn btn-primary btn-block mb-3" id="alert-success" type="button" onclick="compare();">Analyze</button>


<script src="/static/dist-assets/js/plugins/jquery.smartWizard.min.js"></script>
<script src="/static/dist-assets/js/scripts/smart.wizard.script.min.js"></script>







<script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<link href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css" rel="stylesheet" />

<script type="text/javascript" src="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.12/js/dataTables.checkboxes.min.js"></script>
<link type="text/css" href="//gyrocode.github.io/jquery-datatables-checkboxes/1.2.12/css/dataTables.checkboxes.css" rel="stylesheet" />






<style>
    #mynetwork {
    width: 100%;
    height: 900px;
    border: 1px solid lightgray;
    }

    div.vis-network {
    background-color: rgb(228, 228, 228);
  }

</style>
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>










    <script>
 

 
        var tracks = $.ajax({
            type: 'POST',
            async: false,
            url: '{% url "analyzer:get_tracks" %}',
            dataType: 'json'
            
        }).responseJSON;

        
        var table_track1 = $('#time_1').DataTable({
            data: tracks,

            'columnDefs': [
                {
                    'targets': 0,
                    'checkboxes': {
                        'selectRow': true
                    }
                }
            ],
            'select': {
                'style': 'multi'
            },
            'order': [[1, 'asc']]
        });

        var table_track2 = $('#time_2').DataTable({
            data: tracks,

            'columnDefs': [
                {
                    'targets': 0,
                    'checkboxes': {
                        'selectRow': true
                    }
                }
            ],
            'select': {
                'style': 'multi'
            },
            'order': [[1, 'asc']]
        });

        

        function step_first(){
            var rows_selected = table_track1.column(0).checkboxes.selected();
            
            // Iterate over all selected checkboxes
            if(rows_selected.length > 0){
                var arr = []
                $.each(rows_selected, function(index, rowId){arr.push(rowId)});
                var dates = $.ajax({
                    type: 'POST',
                    async: false,
                    url: '{% url "analyzer:call_ajax" %}',
                    dataType: 'json',
                    data: {'which':'entity_domain_get_dates',
                           'data_sources': arr.toString()
                          }
                    
                }).responseJSON;
                 

                var start_date = document.getElementById("selectStartDate1"); 
                var end_date = document.getElementById("selectEndDate1"); 

                for (i = start_date.length-1; i >= 0; i--) {
                    start_date.options[i] = null;
                    end_date.options[i] = null;
                    }

                $.each(dates['dates'], function(i, p) {
                    var el = document.createElement("option");
                    el.textContent = p;
                    el.value = p;
                    start_date.appendChild(el);
        
                });

                $.each(dates['dates'], function(i, p) {
                    var el = document.createElement("option");
                    el.textContent = p;
                    el.value = p;
                    end_date.appendChild(el);
        
                });
            } else {
                alert('Please select a data source first!');
            }
            
        }



        function step_second(){
            var rows_selected = table_track2.column(0).checkboxes.selected();
            
            // Iterate over all selected checkboxes
            if(rows_selected.length > 0){
                var arr = []
                $.each(rows_selected, function(index, rowId){arr.push(rowId)});
                var dates = $.ajax({
                    type: 'POST',
                    async: false,
                    url: '{% url "analyzer:call_ajax" %}',
                    dataType: 'json',
                    data: {'which':'entity_domain_get_dates',
                           'data_sources': arr.toString()
                          }
                    
                }).responseJSON;
                 

                var start_date = document.getElementById("selectStartDate2"); 
                var end_date = document.getElementById("selectEndDate2"); 

                for (i = start_date.length-1; i >= 0; i--) {
                    start_date.options[i] = null;
                    end_date.options[i] = null;
                    }

                $.each(dates['dates'], function(i, p) {
                    var el = document.createElement("option");
                    el.textContent = p;
                    el.value = p;
                    start_date.appendChild(el);
        
                });

                $.each(dates['dates'], function(i, p) {
                    var el = document.createElement("option");
                    el.textContent = p;
                    el.value = p;
                    end_date.appendChild(el);
        
                });
            } else {
                alert('Please select a data source first!');
            }
            
        }
    
        

        function compare(){
            alert('BURADA')
            
            var track_selected1 = table_track1.column(0).checkboxes.selected();
            var track_selected2 = table_track2.column(0).checkboxes.selected();

            var arr1 = [];
            var arr2 = []

            $.each(track_selected1, function(index, rowId){arr1.push(rowId)});
            $.each(track_selected2, function(index, rowId){arr2.push(rowId)});

            var start_date1 = document.getElementById("selectStartDate1").value; 
            var end_date1 = document.getElementById("selectEndDate1").value; 

            var start_date2= document.getElementById("selectStartDate2").value; 
            var end_date2 = document.getElementById("selectEndDate2").value; 

            
            alert([arr1, arr2, start_date1, end_date1, start_date2, end_date2])

            var comparisor_data = $.ajax({
                    type: 'POST',
                    async: false,
                    url: '{% url "analyzer:call_ajax" %}',
                    dataType: 'json',
                    data: {'which':'get_comparisons',
                           'source1': arr1.toString(),
                           'source2': arr2.toString(),
                           'start_date1':start_date1,
                           'start_date2':start_date1,
                           'end_date1':end_date1,
                           'end_date2':end_date2
                          }
                    
                }).responseJSON;

        }
 

        

    </script>




<div class="col-md-12">
    <div class="card mb-4">
        <div class="card-body">
            <div id="chartdiv5"></div>
            <div id="mynetwork"></div>
        </div>
    </div>
</div>










<!-- Styles -->
<style>
    #chartdiv5 {
      width: 100%;
    height:550px;
    max-width:100%;
    background: rgb(18, 27, 95);
    }
    </style>
    
    <!-- Resources -->
    <script src="https://cdn.amcharts.com/lib/4/core.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/charts.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/plugins/forceDirected.js"></script>
    <script src="https://cdn.amcharts.com/lib/4/themes/animated.js"></script>
    
    <!-- Chart code -->
    <script>
    function draw_graph_fancy(arr,arr2) {
    
    // Themes begin
    am4core.useTheme(am4themes_animated);
    // Themes end
    
    
    
    var chart = am4core.create("chartdiv5", am4plugins_forceDirected.ForceDirectedTree);
    var networkSeries = chart.series.push(new am4plugins_forceDirected.ForceDirectedSeries())
    
    chart.data = $.ajax({
            type: 'POST',
            async: false,
            url: '{% url "analyzer:call_ajax" %}',
            dataType: 'json',
            data: {'which':'domain_top_entities_graph', 
                   'track': arr.toString(),
                   'domain': arr2.toString()}
            
        }).responseJSON;
    
    networkSeries.dataFields.value = "value";
    networkSeries.dataFields.name = "name";
    networkSeries.dataFields.children = "children";
    networkSeries.nodes.template.tooltipText = "{name}:{value}";
    networkSeries.nodes.template.fillOpacity = 1;
    
    networkSeries.nodes.template.label.text = "{name}"
    networkSeries.fontSize = 10;
    
    networkSeries.links.template.strokeWidth = 1;
    
    var hoverState = networkSeries.links.template.states.create("hover");
    hoverState.properties.strokeWidth = 3;
    hoverState.properties.strokeOpacity = 1;
    
    networkSeries.nodes.template.events.on("over", function(event) {
      event.target.dataItem.childLinks.each(function(link) {
        link.isHover = true;
      })
      if (event.target.dataItem.parentLink) {
        event.target.dataItem.parentLink.isHover = true;
      }
    
    })
    
    networkSeries.nodes.template.events.on("out", function(event) {
      event.target.dataItem.childLinks.each(function(link) {
        link.isHover = false;
      })
      if (event.target.dataItem.parentLink) {
        event.target.dataItem.parentLink.isHover = false;
      }
    })
    
    }; // end am4core.ready()
    </script>
    
   

{% endblock %}
</div>

